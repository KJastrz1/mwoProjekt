name: Selenium

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0.x
      - name: App Settings Variable Substitution
        uses: microsoft/variable-substitution@v1
        with:
          files: "P05Shop.API/appsettings.json"
        env:
          ConnectionStrings.DefaultConnection: ${{ secrets.DB_CONNECTION_STRING }}
      - name: Restore Dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --configuration Release
      - name: Run API
        run: nohup dotnet run --project P05Shop.API/P05Shop.API.csproj > API.log &
      - name: Run Web App
        run: nohup dotnet run --urls http://0.0.0.0:7255 --project P10ShopWebAPPMVC.Client/P10ShopWebAPPMVC.Client.csproj > App.log &
      - name: Wait
        run: sleep 10s

      - uses: browser-actions/setup-chrome@latest
      - run: chrome --version

      - name: Run tests and capture output
        id: tests
        run: |         
          dotnet test > TestOutput.log
          TEST_OUTPUT=$(grep -i -A 3 Failed TestOutput.log)
          echo "TEST_OUTPUT=${TEST_OUTPUT}" >> $GITHUB_ENV



      - name: Send bug to Azure DevOps
        if: steps.tests.outcome != 'success'
        uses: fjogeleit/http-request-action@v1
        with:
          url: "https://dev.azure.com/01158651/mwoProjekt/_apis/wit/workitems/$task?api-version=7.1-preview.3"
          method: "POST"
          username: ${{ secrets.AZURE_USERNAME }}
          password: ${{ secrets.AZURE_TOKEN }}
          customHeaders: '{"Content-Type": "application/json-patch+json"}'
          data: |
              [
                {
                  "op": "add",
                  "path": "/fields/System.Title",
                  "value": "Pipeline error: Your Error Title"
                },
                {
                  "op": "add",
                  "path": "/fields/System.Description",
                  "value": "${{ env.TEST_OUTPUT }}"
                }
              ]
